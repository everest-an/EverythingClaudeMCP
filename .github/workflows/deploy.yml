name: Deploy to AWS EC2

on:
  push:
    branches: [master]

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # ----------------------------------------------------------------
  # 1. Detect which parts of the project changed
  # ----------------------------------------------------------------
  changes:
    runs-on: ubuntu-latest
    outputs:
      landing: ${{ steps.filter.outputs.landing }}
      mcp: ${{ steps.filter.outputs.mcp }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            landing:
              - 'landing/**'
            mcp:
              - 'mcp-server/**'
              - 'src/**'
              - 'scripts/**'
              - 'Dockerfile'
              - 'deploy/**'
              - 'data/**'

  # ----------------------------------------------------------------
  # 2. Build check — validate everything compiles before deploying
  # ----------------------------------------------------------------
  build-check:
    runs-on: ubuntu-latest
    needs: changes
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build landing
        if: needs.changes.outputs.landing == 'true'
        working-directory: landing
        run: |
          npm ci
          npx prisma generate
          npm run build

      - name: Build MCP server
        if: needs.changes.outputs.mcp == 'true'
        working-directory: mcp-server
        run: |
          npm ci
          npm run build

  # ----------------------------------------------------------------
  # 3. Deploy to EC2 via SSH
  # ----------------------------------------------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: [changes, build-check]
    if: needs.changes.outputs.landing == 'true' || needs.changes.outputs.mcp == 'true'
    steps:
      - name: Deploy landing
        if: needs.changes.outputs.landing == 'true'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          debug: true
          script: |
            set -e
            cd /opt/awesomecontext
            git pull origin master

            cd landing
            npm ci --omit=dev
            npx prisma generate
            npm run build

            pm2 restart landing 2>/dev/null || pm2 start npm --name landing -- start
            pm2 save

      - name: Deploy MCP (Docker)
        if: needs.changes.outputs.mcp == 'true'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 10m
          script: |
            set -e
            cd /opt/awesomecontext
            git pull origin master

            cd deploy
            docker compose -f docker-compose.prod.yml up -d --build --remove-orphans
            docker image prune -f

  # ----------------------------------------------------------------
  # 4. Health check — verify services are running
  # ----------------------------------------------------------------
  health-check:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Wait for services to start
        run: sleep 15

      - name: Check landing
        if: always()
        run: |
          curl -sf --max-time 10 https://awesomecontext.awareness.market || echo "::warning::Landing health check failed"

      - name: Check MCP
        if: always()
        run: |
          curl -sf --max-time 10 https://mcp.awesomecontext.dev/health || echo "::warning::MCP health check failed"

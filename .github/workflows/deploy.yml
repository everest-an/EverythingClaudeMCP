name: Deploy to AWS EC2

on:
  push:
    branches: [master]

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # ----------------------------------------------------------------
  # 1. Detect which parts of the project changed
  # ----------------------------------------------------------------
  changes:
    runs-on: ubuntu-latest
    outputs:
      landing: ${{ steps.filter.outputs.landing }}
      mcp: ${{ steps.filter.outputs.mcp }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            landing:
              - 'landing/**'
              - '.github/workflows/deploy.yml'
            mcp:
              - 'mcp-server/**'
              - 'src/**'
              - 'scripts/**'
              - 'Dockerfile'
              - 'deploy/**'
              - 'data/**'

  # ----------------------------------------------------------------
  # 2. Build check — validate everything compiles before deploying
  # ----------------------------------------------------------------
  build-check:
    runs-on: ubuntu-latest
    needs: changes
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build landing
        if: needs.changes.outputs.landing == 'true'
        working-directory: landing
        run: |
          npm ci
          npx prisma generate
          npm run build

      - name: Build MCP server
        if: needs.changes.outputs.mcp == 'true'
        working-directory: mcp-server
        run: |
          npm ci
          npm run build

  # ----------------------------------------------------------------
  # 3. Deploy to EC2 via SSH
  # ----------------------------------------------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: [changes, build-check]
    if: needs.changes.outputs.landing == 'true' || needs.changes.outputs.mcp == 'true'
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy landing
        if: needs.changes.outputs.landing == 'true'
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'SCRIPT'
          set -e
          cd /home/ec2-user/EverythingClaudeMCP
          git pull origin master

          cd landing
          npm ci
          npx prisma generate
          rm -rf .next
          npm run build

          # Remove stale PM2 processes that may conflict
          pm2 stop awesomecontext-landing 2>/dev/null || true
          pm2 delete awesomecontext-landing 2>/dev/null || true
          PORT=3200 pm2 restart landing --update-env 2>/dev/null || PORT=3200 pm2 start npm --name landing -- start
          pm2 save
          SCRIPT

      - name: Deploy MCP (Docker)
        if: needs.changes.outputs.mcp == 'true'
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'SCRIPT'
          set -e
          cd /home/ec2-user/EverythingClaudeMCP
          git pull origin master

          cd deploy
          # Rebuild cloud (MCP) service only; leave postgres/certbot untouched
          docker compose -f docker-compose.prod.yml up -d --build --no-deps cloud
          docker compose -f docker-compose.prod.yml up -d nginx
          docker image prune -f
          SCRIPT

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

  # ----------------------------------------------------------------
  # 4. Health check — verify services are running
  # ----------------------------------------------------------------
  health-check:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Wait for services to start
        run: sleep 15

      - name: Check landing
        if: always()
        run: |
          curl -sf --max-time 10 https://awesomecontext.awareness.market || echo "::warning::Landing health check failed"

      - name: Check MCP
        if: always()
        run: |
          curl -sf --max-time 10 https://awesomecontext.awareness.market/mcp/health || echo "::warning::MCP health check failed"
